<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="theme-color" content="#7B2D8E">
<meta name="robots" content="noindex,nofollow">
<title>Vanta Sales - Open App</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans',sans-serif;background:linear-gradient(135deg,#7B2D8E 0%,#3B82F6 35%,#14B8A6 70%,#10B981 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;color:#fff}
.c{text-align:center;max-width:400px;width:100%}
.logo-box{margin-bottom:40px;padding:24px 32px;background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.15);display:inline-block}
.logo{max-width:200px;height:auto}
.logo-text{font-size:24px;font-weight:700;color:#3B82F6}
h1{font-size:28px;font-weight:700;margin-bottom:12px;letter-spacing:-0.5px}
p{font-size:16px;opacity:.95;margin-bottom:32px;line-height:1.5}
.btn{display:inline-block;background:#fff;color:#3B82F6;font-family:'IBM Plex Sans',sans-serif;font-size:17px;font-weight:600;padding:16px 48px;border-radius:12px;text-decoration:none;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:transform .2s,box-shadow .2s}
.btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.25)}
.btn:active{transform:translateY(-1px)}
.ld{margin-top:24px;font-size:14px;opacity:.85;display:flex;align-items:center;justify-content:center;gap:10px}
.sp{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.help{margin-top:40px;font-size:13px;opacity:.75}
.err{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);border-radius:12px;padding:20px;margin-bottom:24px}
.err p{color:#FEE2E2;font-weight:500;margin:0}
.hide{display:none}
.otp-box{background:rgba(255,255,255,.12);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:20px;margin-top:24px;margin-bottom:8px}
.otp-label{font-size:13px;opacity:.85;margin-bottom:8px !important;font-weight:500}
.otp-code{font-size:32px;font-weight:700;letter-spacing:8px;font-family:'Courier New',monospace;margin-bottom:12px !important;opacity:1}
.copy-btn{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;font-family:'IBM Plex Sans',sans-serif;font-size:13px;font-weight:600;padding:8px 20px;border-radius:8px;cursor:pointer;transition:background .2s}
.copy-btn:hover{background:rgba(255,255,255,.3)}
.copy-btn:active{background:rgba(255,255,255,.15)}
.divider{display:flex;align-items:center;gap:12px;margin:20px 0}
.divider-line{flex:1;height:1px;background:rgba(255,255,255,.25)}
.divider-text{font-size:13px;opacity:.7;margin-bottom:0}
</style>
</head>
<body>
<div class="c">
<div class="logo-box">
<img src="https://vikor.quickbase.com/up/bn2qw48zi/g/r6/eh/vb" alt="Vanta" class="logo" id="logo" onerror="this.style.display='none';document.getElementById('lt').style.display='block'">
<span class="logo-text hide" id="lt">Vanta Sales</span>
</div>

<div id="error-view" class="hide">
<h1>Link Error</h1>
<div class="err"><p id="error-msg">There was a problem with this link.</p></div>
<p class="help">Please request a new link from your administrator.</p>
</div>

<div id="success-view">
<h1>Open Vanta Sales</h1>
<p>Tap the button below to continue in the app.</p>
<a href="#" class="btn" id="open-btn" rel="noreferrer noopener">Open App</a>
<div id="otp-section" class="hide">
<div class="divider">
<span class="divider-line"></span>
<span class="divider-text">or enter code manually</span>
<span class="divider-line"></span>
</div>
<div class="otp-box">
<p class="otp-label">Your verification code</p>
<p class="otp-code" id="otp-display"></p>
<button class="copy-btn" id="copy-btn" onclick="copyCode()">Copy Code</button>
</div>
</div>
<div class="ld" id="ld"><span>Tap the button above to continue</span></div>
<p class="help">Don't have the app? Contact your administrator.</p>
</div>
</div>

<script>
(function() {
  var APP_SCHEME = 'vantasalesapp';
  
  // Get params from both query string and hash fragment
  var queryParams = new URLSearchParams(window.location.search);
  var hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : new URLSearchParams();
  
  // Helper to get param from either source
  // Query params take priority (survive Proofpoint/proxy redirects)
  // Hash params are fallback for backward compatibility
  function getParam(name) {
    return queryParams.get(name) || hashParams.get(name);
  }
  
  // Check for errors first
  var error = getParam('error');
  var errorDesc = getParam('error_description');
  
  if (error) {
    document.getElementById('success-view').classList.add('hide');
    document.getElementById('error-view').classList.remove('hide');
    
    var msg = errorDesc || 
      (error === 'access_denied' ? 'Access denied. Contact your administrator.' :
       (error === 'expired' || error === 'otp_expired') ? 'This link has expired. Please request a new one.' :
       'There was a problem with this link.');
    document.getElementById('error-msg').textContent = msg;
    return;
  }
  
  // Check for token-based flow
  // Email template format: https://landing/?token_hash=XXX&type=recovery&email=user@example.com&token=123456
  var token = getParam('token');
  var tokenHash = getParam('token_hash');
  var type = getParam('type');
  var email = getParam('email');
  
  // Show OTP code section only when token is exactly 6 digits (valid numeric OTP from email template)
  if (token && /^\d{6}$/.test(token)) {
    document.getElementById('otp-display').textContent = token;
    document.getElementById('otp-section').classList.remove('hide');
    // Store for copy functionality
    window._otpCode = token;
  }
  
  // Build deep link based on what we have
  var deepLink;
  
  if (token || tokenHash) {
    // Token-based flow: pass token directly to app for verifyOtp
    var params = [];
    if (token) params.push('token=' + encodeURIComponent(token));
    if (tokenHash) params.push('token_hash=' + encodeURIComponent(tokenHash));
    if (type) params.push('type=' + encodeURIComponent(type));
    if (email) params.push('email=' + encodeURIComponent(email));
    
    deepLink = APP_SCHEME + '://callback?' + params.join('&');
    console.log('Token-based deep link (token redacted for security)');
  } else {
    // Legacy flow: pass through query params and hash fragment as-is
    // This handles redirects from Supabase /verify endpoint
    deepLink = APP_SCHEME + '://callback' + window.location.search + window.location.hash;
    console.log('Legacy deep link flow');
  }
  
  // Set button href - user must tap to trigger (iOS requires user-initiated action)
  document.getElementById('open-btn').href = deepLink;
  
  // No auto-redirect - iOS blocks programmatic URL scheme triggers with a restrictive prompt
  // User must tap the "Open App" button for the friendlier "Open in app?" prompt
})();

function copyCode() {
  var code = window._otpCode;
  if (!code) return;
  
  var btn = document.getElementById('copy-btn');
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code).then(function() {
      btn.textContent = 'Copied!';
      setTimeout(function() { btn.textContent = 'Copy Code'; }, 2000);
    }).catch(function() {
      fallbackCopy(code, btn);
    });
  } else {
    fallbackCopy(code, btn);
  }
}

function fallbackCopy(text, btn) {
  var ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  try {
    document.execCommand('copy');
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = 'Copy Code'; }, 2000);
  } catch (e) {
    btn.textContent = 'Copy failed';
    setTimeout(function() { btn.textContent = 'Copy Code'; }, 2000);
  }
  document.body.removeChild(ta);
}
</script>
</body>
</html>
